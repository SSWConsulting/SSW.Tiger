services:
  meeting-processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting-summariser
    environment:
      - NODE_ENV=production
      # Claude Code CLI authentication (choose ONE method):

      # Option 1: OAuth Token (Recommended for Claude Pro/Max subscriptions)
      # Get token: Run "claude setup-token" on your local machine
      # Format: sk-ant-oat01-...
      # Benefits: Subscription rate limits, priority access
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}

      # Option 2: API Key (For pay-per-use or SDK usage)
      # Get key: https://console.anthropic.com/settings/keys
      # Format: sk-ant-api03-...
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Priority: CLAUDE_CODE_OAUTH_TOKEN > ANTHROPIC_API_KEY
      # Set ONE in your .env file (OAuth token recommended for subscriptions)

      # Surge credentials (for Claude Code to use during deployment)
      - SURGE_EMAIL=${SURGE_EMAIL}
      - SURGE_TOKEN=${SURGE_TOKEN}

      # Microsoft Graph API (Azure mode - for webhook-triggered processing)
      # These are passed by Azure Container Apps when triggered by webhook
      - GRAPH_CLIENT_ID=${GRAPH_CLIENT_ID}
      - GRAPH_CLIENT_SECRET=${GRAPH_CLIENT_SECRET}
      - GRAPH_TENANT_ID=${GRAPH_TENANT_ID}
      - GRAPH_USER_ID=${GRAPH_USER_ID}
      - GRAPH_MEETING_ID=${GRAPH_MEETING_ID}
      - GRAPH_TRANSCRIPT_ID=${GRAPH_TRANSCRIPT_ID}

      # Teams notification via Logic App (optional)
      - LOGIC_APP_URL=${LOGIC_APP_URL}

      # Meeting filter pattern (optional, default: "sprint")
      # Set to ".*" to process all meetings
      - MEETING_FILTER_PATTERN=${MEETING_FILTER_PATTERN:-sprint}

      # Output directory (defaults to ./output)
      - OUTPUT_DIR=${OUTPUT_DIR:-/app/output}
    volumes:
      # Mount local projects directory - CANONICAL storage for all meetings
      - ./projects:/app/projects
      # Mount dropzone for input transcripts
      - ./dropzone:/app/dropzone
      # Mount output directory - OPTIONAL convenience copy of dashboards
      - ./output:/app/output
      # Mount templates for customization
      - ./templates:/app/templates:ro
      # Mount CLAUDE.md instructions
      - ./CLAUDE.md:/app/CLAUDE.md:ro
      # Mount agent configurations
      - ./.claude:/app/.claude:ro
    # Command override examples:
    # Process a specific transcript:
    # command: ["/app/dropzone/2026-01-22-standup.vtt", "yakshaver"]
    # 
    # Multiple meetings same day:
    # command: ["/app/dropzone/2026-01-22-sprint-review.vtt", "yakshaver"]
    #
    # Note: Transcript filenames MUST start with YYYY-MM-DD format
    
    # Restart policy
    restart: "no"
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M
