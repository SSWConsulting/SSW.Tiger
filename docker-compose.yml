services:
  meeting-processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting-summariser
    environment:
      - NODE_ENV=production
      # Claude Code CLI authentication (choose ONE method):

      # Option 1: OAuth Token (Recommended for Claude Pro/Max subscriptions)
      # Get token: Run "claude setup-token" on your local machine
      # Format: sk-ant-oat01-...
      # Benefits: Subscription rate limits, priority access
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}

      # Option 2: API Key (For pay-per-use or SDK usage)
      # Get key: https://console.anthropic.com/settings/keys
      # Format: sk-ant-api03-...
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Priority: CLAUDE_CODE_OAUTH_TOKEN > ANTHROPIC_API_KEY
      # Set ONE in your .env file (OAuth token recommended for subscriptions)

      # Surge credentials (for Claude Code to use during deployment)
      # Note: Surge expects SURGE_LOGIN, not SURGE_EMAIL
      - SURGE_LOGIN=${SURGE_LOGIN:-${SURGE_EMAIL}}
      - SURGE_TOKEN=${SURGE_TOKEN}

      # Output directory (defaults to ./output)
      - OUTPUT_DIR=${OUTPUT_DIR:-/app/output}
    volumes:
      # Mount local projects directory - CANONICAL storage for all meetings
      - ./projects:/app/projects
      # Mount dropzone for input transcripts
      - ./dropzone:/app/dropzone
      # Mount output directory - OPTIONAL convenience copy of dashboards
      - ./output:/app/output
      # Mount templates for customization
      - ./templates:/app/templates:ro
      # Mount CLAUDE.md instructions
      - ./CLAUDE.md:/app/CLAUDE.md:ro
      # Mount agent configurations
      - ./.claude:/app/.claude:ro
    # Command override examples:
    # Process a specific transcript:
    # command: ["/app/dropzone/2026-01-22-standup.vtt", "yakshaver"]
    # 
    # Multiple meetings same day:
    # command: ["/app/dropzone/2026-01-22-sprint-review.vtt", "yakshaver"]
    #
    # Note: Transcript filenames MUST start with YYYY-MM-DD format
    
    # Restart policy
    restart: "no"
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

# Example usage:
#
# 1. Set your authentication (choose one):
#    # Option A: API Key
#    export ANTHROPIC_API_KEY=your-key-here
#    # Option B: OAuth Token (subscription - get from Claude CLI)
#    # Run on host: claude /status | grep "Auth Token"
#    export CLAUDE_CODE_OAUTH_TOKEN=your-oauth-token-here
#
# 2. Set Surge credentials for deployment
#    export SURGE_EMAIL=your-email@example.com
#    export SURGE_TOKEN=your-surge-token
#
# 3. Build the container:
#    docker-compose build
#
# 4. Run with a transcript:
#    docker-compose run --rm meeting-processor /app/dropzone/2026-01-22-standup.vtt projectname
#
# 5. View logs:
#    docker-compose logs -f meeting-processor
#
# 6. Verify authentication in container:
#    docker-compose run --rm meeting-processor sh -c "claude /status"
#
# Note: Each meeting is isolated by its filename. Multiple meetings on the same date 
#       are supported (e.g., 2026-01-22-standup.vtt, 2026-01-22-sprint-review.vtt)
