version: '3.8'

services:
  meeting-processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting-summariser
    environment:
      # Claude Code CLI authentication (use one or both - subscription takes priority)
      # Option 1: API Key (pay-as-you-go)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      # Option 2: Subscription (fixed monthly cost, preferred for high volume)
      - CLAUDE_SUBSCRIPTION_TOKEN=${CLAUDE_SUBSCRIPTION_TOKEN}

      # Surge credentials (for Claude Code to use during deployment)
      - SURGE_LOGIN=${SURGE_EMAIL}
      - SURGE_TOKEN=${SURGE_TOKEN}

      # Output directory (defaults to ./output)
      - OUTPUT_DIR=${OUTPUT_DIR:-/app/output}
    volumes:
      # Mount local projects directory - CANONICAL storage for all meetings
      - ./projects:/app/projects
      # Mount dropzone for input transcripts
      - ./dropzone:/app/dropzone
      # Mount output directory - OPTIONAL convenience copy of dashboards
      - ./output:/app/output
      # Mount templates for customization
      - ./templates:/app/templates:ro
      # Mount CLAUDE.md instructions
      - ./CLAUDE.md:/app/CLAUDE.md:ro
      # Mount agent configurations
      - ./.claude:/app/.claude:ro
    # Command override examples:
    # Process a specific transcript:
    # command: ["/app/dropzone/2026-01-22-standup.vtt", "yakshaver"]
    # 
    # Multiple meetings same day:
    # command: ["/app/dropzone/2026-01-22-sprint-review.vtt", "yakshaver"]
    #
    # Note: Transcript filenames MUST start with YYYY-MM-DD format
    
    # Restart policy
    restart: "no"
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

# Example usage:
#
# 1. Set your authentication (choose one):
#    # Option A: API Key
#    export ANTHROPIC_API_KEY=your-key-here
#    # Option B: Subscription (preferred for high volume)
#    export CLAUDE_SUBSCRIPTION_TOKEN=your-token-here
#
# 2. Set Surge credentials for deployment
#    export SURGE_EMAIL=your-email@example.com
#    export SURGE_TOKEN=your-surge-token
#
# 3. Build the container:
#    docker-compose build
#
# 4. Run with a transcript:
#    docker-compose run --rm meeting-processor /app/dropzone/2026-01-22-standup.vtt projectname
#
# 5. View logs:
#    docker-compose logs -f meeting-processor
#
# Note: Each meeting is isolated by its filename. Multiple meetings on the same date 
#       are supported (e.g., 2026-01-22-standup.vtt, 2026-01-22-sprint-review.vtt)
